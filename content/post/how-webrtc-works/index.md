+++
title = 'WebRTC é‹ä½œåŸç†å…¥é–€ï¼šä¸€æ¬¡ææ‡‚ SDPã€ICE èˆ‡ NAT ç©¿é€'
date = 2024-06-22T14:00:00+08:00
draft = false
featured_image = 'featured_image.png'
description = 'æ•´ç† WebRTC çš„åŸºæœ¬æ¦‚å¿µèˆ‡é€£ç·šæµç¨‹ï¼ŒåŒ…å« RTCPeerConnectionã€SDP èˆ‡ ICE Candidateï¼Œè¨˜éŒ„é€£ç·šä¸­æœƒç”¨åˆ°çš„å”å®šèˆ‡æ¦‚å¿µ'
tags = ['Frontend', 'WebRTC']
+++

## Overview

å·¥ä½œä¸Šé–‹å§‹æ¥è§¸ RTC SDK ç›¸é—œçš„é–‹ç™¼ï¼Œæƒ³èµ·éå»æœ‰åˆ†äº«é WebRTC çš„é‹ä½œåŸç†ï¼Œè¶è‘—é€±æœ«æœ‰ç©ºæª”ä¾†é‡æ–°è¤‡ç¿’ä¸€ä¸‹ã€‚

## ä»€éº¼æ˜¯ WebRTCï¼Ÿ

**WebRTC** (Web Real-Time Communication) æ˜¯ä¸€å€‹é–‹æ”¾æ¨™æº–ï¼Œç”¨æ–¼åœ¨ç€è¦½å™¨ä¸­ä¸éœ€å®‰è£é¡å¤–æ’ä»¶ï¼Œå³å¯å¯¦ç¾**å¯¦æ™‚éŸ³è¨Šã€è¦–è¨Šå’Œæ•¸æ“šå‚³è¼¸**ã€‚
åŸºæœ¬ä¸Šè¦–è¨Šæœƒè­°éƒ½æ˜¯é€é WebRTC ä¾†å¯¦ç¾ï¼Œå¹¾ä¹æ‰€æœ‰å³æ™‚äº’å‹•åŠŸèƒ½éƒ½æœƒç”¨åˆ° WebRTCï¼Œè€Œå¸¸è¦‹çš„çš„éŠæˆ²ç›´æ’­ï¼ŒåŸºæœ¬ä¸Šå»¶é²æœƒæ¯”è¼ƒé«˜ï¼Œä¸»è¦ä½¿ç”¨çš„æŠ€è¡“æ‡‰è©²æ˜¯ä¸²æµ (Streaming) ä¾†å¯¦ç¾ï¼Œé€™é‚Šè¦æ³¨æ„ä¸€ä¸‹ã€‚

## WebRTC çš„æ ¸å¿ƒæ¦‚å¿µ

æˆ‘å€‘å¯ä»¥é€éæ¨¡æ“¬å…©ä½è‘£äº‹é•·è¦é€²è¡Œé–‹æœƒä¾†å­¸ç¿’ WebRTC çš„é‹ä½œåŸç†ï¼š

1. å‘ŠçŸ¥ç§˜æ›¸æº–å‚™è¦é–‹æœƒ: å‰µå»º PeerConnection å¯¦ä¾‹ï¼Œä¸¦è¨­å®š ICE é€£ç·šé€šé“çš„åå–®
2. è‘£äº‹é•·è«‹ç§˜æ›¸æŠŠåç‰‡äº¤çµ¦å°æ–¹ï¼š ä½¿ç”¨ SDP äº¤æ›å½¼æ­¤çš„è³‡è¨Š
3. ç¢ºèªè¦åœ¨å“ªå€‹æœƒè­°å®¤é€²è¡Œè«‡è©±: ä½¿ç”¨ ICE å”å®šä¾†ç¢ºèªå½¼æ­¤çš„ç¶²è·¯ç‹€æ…‹
4. é›™æ–¹é–‹å§‹é€²è¡Œå°è©±: å®Œæˆ P2P é€£ç·šï¼Œé–‹å§‹é€²è¡Œå°è©±

### 1. RTCPeerConnectionï¼šå»ºç«‹é€£ç·šçš„èµ·é»

ç§˜æ›¸å°±åƒæ˜¯ **`RTCPeerConnection`** å¯¦ä¾‹ï¼Œå®ƒæ˜¯ WebRTC é€£ç·šçš„æ ¸å¿ƒã€‚æˆ‘å€‘éœ€è¦å…ˆå»ºç«‹é€™å€‹å¯¦ä¾‹ï¼Œæ‰èƒ½é–‹å§‹å¾ŒçºŒçš„æ‰€æœ‰æ­¥é©Ÿã€‚

è€Œ PeerConnection å¯¦ä¾‹çš„å‰µå»ºï¼Œé€šå¸¸æœƒåœ¨æº–å‚™å»ºç«‹é€£ç·šæ™‚å°±å‰µå»ºï¼Œé€™æ¨£æ‰èƒ½ç¢ºä¿å¾ŒçºŒäº¤æ›è³‡è¨Šèˆ‡é€£ç·šé †åˆ©é€²è¡Œã€‚

åœ¨å‰µå»ºå¯¦ä¾‹æ™‚ï¼Œæˆ‘å€‘é€šå¸¸æœƒæä¾›ä¸€çµ„ **ICE ä¼ºæœå™¨** (STUN/TURN) çš„è¨­å®šï¼Œé€™å°±åƒæ˜¯å‘Šè¨´ç§˜æ›¸å¯èƒ½æœ‰å“ªäº›æœƒè­°åœ°é»å¯ä»¥é¸æ“‡ã€‚

### 2. SDP (Session Description Protocol)ï¼šäº¤æ›åç‰‡

åœ¨å°è«‡ä¸­æˆ‘å€‘éœ€è¦çŸ¥é“åå­—ï¼Œå°æ–¹è¬›ä»€éº¼èªè¨€ï¼Œèˆˆè¶£æ˜¯ä»€éº¼ï¼Œæ‰èƒ½é †åˆ©çš„é€²è¡Œå°è©±ï¼Œè€Œé€™åœ¨ WebRTC è£¡å°±æ˜¯é€é **SDP (Session Description Protocol)** ä¾†äº¤æ›å½¼æ­¤çš„è³‡è¨Šã€‚

SDP æ˜¯ä¸€ç¨®æè¿°åª’é«”æœƒè©±ï¼ˆä¾‹å¦‚éŸ³è¨Šã€è¦–è¨Šçš„ç·¨è§£ç¢¼å™¨ã€å‚³è¼¸å”å®šç­‰ï¼‰çš„æ¨™æº–æ ¼å¼ã€‚

SDP çš„æ ¼å¼å¦‚ä¸‹
![SDP æ ¼å¼ç¯„ä¾‹](./sdp.png)

å¾ä»¥ä¸Šå¯ä»¥çŸ¥é“é€™äº›è³‡è¨Š

```
ğŸ“„ åŸºæœ¬è³‡è¨Š
ç™¼èµ·äºº IPï¼š10.47.16.5
æœƒè­°åç¨±ï¼šSDP Seminar
ä¸»è¾¦äººä¿¡ç®±ï¼šj.doe@example.com
é€£ç·šåœ°å€ï¼š224.2.17.12/127

ğŸ”Š éŸ³è¨Šè¨­å®š
å‚³è¼¸å”å®šèˆ‡ Portï¼šRTP/AVP over port 49170

ğŸ¥ è¦–è¨Šè¨­å®š
å‚³è¼¸å”å®šèˆ‡ Portï¼šRTP/AVP over port 51372
```

æ‰€ä»¥ SDP å°±åƒæ˜¯æˆ‘å€‘è¦è·Ÿå°æ–¹å°è©±æ™‚ï¼Œæˆ‘å€‘æœƒå…ˆäº¤æ›é›™æ–¹çš„è³‡è¨Šï¼Œé›™æ–¹æ‰èƒ½æ ¹æ“šå½¼æ­¤çš„ç·¨ç¢¼æ–¹å¼ã€åª’é«”æ ¼å¼å»ºç«‹é€£ç·šã€‚

### 3. ICE (Interactive Connectivity Establishment)ï¼šå°‹æ‰¾æœ€ä½³æœƒè­°å®¤

å°±ç®—æˆ‘å€‘äº¤æ›äº†åç‰‡ï¼Œä½†å¦‚æœæˆ‘å€‘æ˜¯åœ¨å¤§é¦¬è·¯ä¸Šäº¤è«‡ï¼Œé‚£å¾ˆæœ‰å¯èƒ½æœƒè¢«æ±½è»Šè²è“‹éï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°ä¸€å€‹é©åˆçš„å ´æ‰€ï¼Œä¾‹å¦‚å’–å•¡å»³å°±å¾ˆæ£’ã€‚
åœ¨ WebRTC ä¸­ï¼Œé€™å€‹éç¨‹å°±æ˜¯é€é **ICE (Interactive Connectivity Establishment)** å”å®šä¾†å°‹æ‰¾å…©ç«¯é»ä¹‹é–“æœ€é©åˆçš„é€šè¨Šè·¯å¾‘ã€‚

ICE æœƒæ”¶é›†æ‰€æœ‰å¯èƒ½çš„é€£ç·šå€™é¸ä½å€ (Candidate)ï¼Œä¸¦å˜—è©¦æ‰¾å‡ºæœ€æœ‰æ•ˆçš„ä¸€æ¢è·¯å¾‘ã€‚Candidate ä¸»è¦åˆ†ç‚ºä¸‰ç¨®é¡å‹ï¼š

- **Host Candidate**: ç›´æ¥ä½¿ç”¨è£ç½®çš„æœ¬åœ° IP ä½å€ã€‚é©ç”¨æ–¼å…©å°è£ç½®åœ¨åŒä¸€å€‹å€åŸŸç¶²è·¯ (LAN) çš„æƒ…æ³ã€‚
- **Server Reflexive Candidate (srflx)**ï¼šé€é **STUN (Session Traversal Utilities for NAT)** ä¼ºæœå™¨ï¼Œå–å¾—è£ç½®åœ¨ NAT (ç¶²è·¯ä½å€è½‰æ›) å¾Œæ–¹çš„å…¬é–‹ IP ä½å€ã€‚é€™æ˜¯æœ€å¸¸è¦‹çš„ NAT ç©¿é€æ–¹å¼ã€‚
- **Relay Candidate (relay)**ï¼šç•¶ STUN å¤±æ•—æ™‚ï¼ˆä¾‹å¦‚å› ç‚ºå°ç¨±å‹ NAT æˆ–åš´æ ¼çš„é˜²ç«ç‰†ï¼‰ï¼Œæµé‡æœƒé€é **TURN (Traversal Using Relays around NAT)** ä¼ºæœå™¨é€²è¡Œä¸­ç¹¼è½‰ç™¼ã€‚é€™æ˜¯æœ€å¯é ä½†æˆæœ¬æœ€é«˜ã€å»¶é²ä¹Ÿæœ€é«˜çš„æ–¹å¼ã€‚

ICE æœƒä¾åºå˜—è©¦ä»¥ä¸‹é€£ç·šæ–¹å¼ï¼š

1.  **Host to Host**ï¼šå˜—è©¦ç›´æ¥é€£ç·šã€‚
2.  **Server Reflexive to Server Reflexive**ï¼šé€é STUN ä¼ºæœå™¨æ‰¾åˆ°çš„å…¬é–‹ä½å€é€²è¡Œé€£ç·šã€‚
3.  **Relay to Relay**ï¼šé€é TURN ä¼ºæœå™¨ä¸­ç¹¼æ‰€æœ‰æµé‡ã€‚

è¦–ç¶²è·¯ç’°å¢ƒè€Œå®šï¼Œä½†è¨±å¤šä¼æ¥­æˆ–æ•™è‚²ç¶²è·¯ç’°å¢ƒå¸¸è¢«é˜²ç«ç‰†é˜»æ“‹ï¼Œæ•…æœ€çµ‚æœƒ fallback åˆ° TURNã€‚

## é–‹å§‹é€²è¡Œå°è©±

åˆ°é€™é‚ŠåŸºæœ¬ä¸Šå°±æ˜¯ ICE é€£ç·šå®Œæˆå¾Œï¼Œé›™æ–¹å°±å¯ä»¥çœ‹åˆ°å½¼æ­¤ä¸¦é€²è¡Œå°è©±

## WebRTC å®Œæ•´é€£ç·šæµç¨‹

å¯¦å‹™ä¸Šï¼ŒSDP å’Œ ICE candidate éç¨‹ä¸­å¯ä»¥åˆ†é–‹å‚³éï¼ˆç¨±ç‚º Trickle ICEï¼‰ï¼Œä¹Ÿå¯ä»¥åˆä½µå‚³éï¼ˆé Trickle ICEï¼‰ã€‚

æ–‡å­—ç‰ˆ

```
A å‰µå»º RTCPeerConnection
B å‰µå»º RTCPeerConnection
A åŠ å…¥å½±éŸ³è£ç½® (getUserMedia & addTrack)
B åŠ å…¥å½±éŸ³è£ç½® (getUserMedia & addTrack)
A createOffer() -> A.setLocalDescription(offer)
B setRemoteDescription(offer)
B createAnswer() -> B.setLocalDescription(answer)
A setRemoteDescription(answer)
A addIceCandidate(B çš„ ice candidate)
B addIceCandidate(A çš„ ice candidate)
ICE å”å®šæ‰¾åˆ°æœ€ä½³è·¯å¾‘ï¼ŒP2P é€£ç·šæˆåŠŸ
```

åœ–ç‰‡ç‰ˆ
![WebRTC é‹ä½œæµç¨‹åœ–](./webrtc-flow.png)

## Signaling Server çš„è§’è‰²èˆ‡ç¸½çµ

ä½ å¯èƒ½æœƒå¥½å¥‡ï¼ŒA å’Œ B æ˜¯å¦‚ä½•äº¤æ› SDP å’Œ ICE Candidate çš„ï¼Ÿé€™å°±æ˜¯ **Signaling Server** çš„å·¥ä½œã€‚WebRTC æœ¬èº«ä¸è² è²¬ä¿¡ä»¤ï¼ˆSignalingï¼‰çš„å‚³éï¼Œé–‹ç™¼è€…éœ€è¦è‡ªè¡Œå»ºç«‹ä¸€å€‹ä¿¡ä»¤é€šé“ï¼Œæœ€å¸¸è¦‹çš„å¯¦ä½œæ–¹å¼å°±æ˜¯ **WebSocket**ã€‚

æ‰€æœ‰åˆå§‹çš„æºé€šï¼ŒåŒ…æ‹¬ SDP Offer/Answer å’Œ ICE Candidatesï¼Œéƒ½å¿…é ˆé€éé€™å€‹ **Signaling Server** ä¾†ä¸­è½‰ã€‚ä¸€æ—¦ ICE æˆåŠŸå»ºç«‹ P2P é€£ç·šï¼Œ **Signaling Server** çš„éšæ®µæ€§ä»»å‹™å°±å®Œæˆäº†ï¼Œå¾ŒçºŒçš„å½±éŸ³è³‡æ–™å°‡ç›´æ¥åœ¨å…©ç«¯é»ä¹‹é–“å‚³è¼¸ã€‚

æ‰€ä»¥ **WebRTC çš„ P2P é€£ç·š** å’Œ **Signaling é€£ç·š** æ˜¯å…©æ¢ç¨ç«‹çš„é€šé“ã€‚ç¾ä»Šçš„ RTC SDK æœå‹™é€šå¸¸æœƒå°‡ Signaling Server åŒ…è£å¥½ï¼Œè®“é–‹ç™¼è€…èƒ½æ›´å°ˆæ³¨æ–¼å‰ç«¯çš„é‚è¼¯ã€‚

éå»å¯«éçš„ RTC é€£ç·šå¯¦ä½œ (ç´”å‰ç«¯ï¼Œç„¡ Signaling Server) å¯ä»¥åƒè€ƒ [WebRTC Demo](https://github.com/marshal604/webrtc-practice)
